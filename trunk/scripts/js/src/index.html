<!DOCTYPE html >
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title> Genesis: Software Analytics Visualization Tool </title>

<script type="text/javascript" src="../lib/mbostock/d3.js"></script>
<script type="text/javascript" src="../lib/mbostock/d3.layout.js"></script>
<script type="text/javascript" src="../lib/mbostock/lib/jquery/jquery.js"></script>
<script type="text/javascript" src="../lib/mbostock/lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../lib/mbostock/d3.geom.js"></script>

<script type="text/javascript" src="argouml/rev_4600_inheritance.js"></script>
<script type="text/javascript" src="argouml/rev_4600_invocations.js"></script>
<script type="text/javascript" src="ModelGraph.js"></script>
<script type="text/javascript" src="Trees.js"></script>
<script type="text/javascript" src="Sunbursts.js"></script>
<script type="text/javascript" src="Graph.js"></script>

<script type="text/javascript" src="edge_data.js"></script>
<script type="text/javascript" src="node_data.js"></script>
<script type="text/javascript" src="displayInfo.js"></script>
<script type="text/javascript" src="force.js"></script>
<script type="text/javascript" src="VisualizationRegister.js"></script>
<script type="text/javascript">

var subclasses = "superclassOf"; var classType = "Class";
var methods = "methods"; 
var classes = "classes";
var attributes = "attributes";
var namespaces = "namespaces"; packageType = "Namespace";

var register = new VisualizationsRegister();

var graphVisualization = function() { 
	this.name = function () { return "Graph" };
	this.setElements = function (element,data) { elements[element].value = data; };
	this.setOptions = function (opt,data) { options[opt] = data; };
	this.setElementOptions = function (element,opt,data) { 
		var el = elements[element];
		if (el)
			el.options[opt] = data;
	};

	this.options = { };
	this.elements = {
		nodes: {
			options: {
				sizeFunction: {
					value: undefined,
					type: "Metric",
				},
			},
			value: undefined,
		},
		edges: {},
	};
	this.visualize = function () {
		var nodes = this.elements["nodes"].value;
		var edges = this.elements["edges"].value;
		if (!nodes || !edges)
			return;
		var graph = genesis.Graph.create(nodes,edges);
		var c = [];

		if (this.options["filter"]) {
			c = this.options["filter"](graph);
		}

		var name = this.name();
		if (this.options["name"])
			name = options[name];
		return roots({ name: name, children: c });
	};
	this.allows = function (data) { return true; };
	return this;
}


function filterNodes (element,relation,graph) {
	var elementType = element;
	var relationName = relation;
	return function (graph) {                                                 
		var c = [];
		for(var n in graph.nodes) {
			var node = graph.nodes[n];
			if (node.properties.ElementType == elementType) {
				c.push( graph.getSubtreeByRelationName(relationName, node.uniqueId) );
			}
		}
 		return c;
	}
}


function testRegister() {
	register.addVisualization(graphVisualization);

	var vis = register.getVisualizations([subclasses]);

	if (vis.length != 0) {

		var graph = vis[0];
		// Example on how to "iterate" through elements, same for options, but they are global options
		// Specific options are in elements..
		for (var el in graph.elements) {
			if (graph.elements[el].options) {
				for (var opt in graph.elements[el].options) {
				}
			}
		}
		// This should be done in someway in the UI -> binding the data to the model
		graph.elements["nodes"].value = node_data.nodes;
		graph.elements["edges"].value = edge_data.edges;
		graph.options["name"] = "RegisterTest";
		graph.options["filter"] = filterNodes(classType,subclasses);
		return graph.visualize();
	}
	return;
}

function plotGraph() {
	var relationName = "invokingMethods";
	var type = "Method";
	
	var graph = genesis.Graph.create(node_data.nodes, edge_data.edges);
	
	var edges = cloneArray(graph.getOneToOneEdges(relationName));
	var nodes = cloneArray(graph.getNodesByType(type));
	var source = nodes.length;
	var sink = source + 1;



	jQuery.each(edges, function(edgeIndex, edgeValue){
		edgeValue.source = source;
		edgeValue.target = sink;
	});
	
	jQuery.each(nodes, function(index, value) {
		var that = value;
        that.group = 1;
		that.name = value.properties.name;
	
		jQuery.each(edges, function(edgeIndex, edgeValue) {
			
	        edgeValue.value = 1;
		
			if(edgeValue.from == that.uniqueId) {
				edgeValue.source = index;	
				that.group++;		
			}
			
			if(edgeValue.to == that.uniqueId) {
				edgeValue.target = index;
				that.group++;
			}
			
			
		});
	});
	
	
	var temp = edges;
	edges = [];
	jQuery.each(temp, function(index, edge) {
		if(edge.target != sink && edge.source != source) {
			edges.push(edge);
		}
	});
	
	forceDirectedGraph(nodes, edges);
	
}


function getTreeFromRelation(relationName, elementType) {
	var graph = genesis.Graph.create(node_data.nodes, edge_data.edges);
	var c = [];
    
    //Example of ho to get the relation edges one to one -> { from: id, to: id }
   // var edgeList = graph.getOneToOneEdges(relationName);
    
	for(var n in graph.nodes) {
		var node = graph.nodes[n];
        if(node.properties.ElementType == elementType)
            c.push( graph.getSubtreeByRelationName(relationName, node.uniqueId) );
	}
		
	return { name: elementType + " " + relationName, children: c };
} 

</script>

<link type="text/css" rel="stylesheet" href="scrollbar.css"/>
<link type="text/css" rel="stylesheet" href="tree.css"/>
</head>
<body onload="">
<ul class="Menu">
	<!--
<li><a href="javascript:tree()"> Tree </li>
<li><a href="javascript:graph()"> Graph </a> </li>
<li><a href="javascript:hist()"> Histogram </a> </li> -->
<li><a href="javascript:javascript:sunburst(getTreeFromRelation(subclasses, classType));"> Inheritance Sunburst <a> </li>
<li><a href="javascript:javascript:sunburst(getTreeFromRelation(methods, classType));"> Invocations Sunburst <a> </li>
    <li> <a href="javascript:roots(getTreeFromRelation(subclasses, classType));"> Inheritance Tree</a> </li>
    <li> <a href="javascript:testRegister();"> Inheritance Tree With Register</a> </li>
    <li> <a href="javascript:roots(getTreeFromRelation(methods, classType));"> Invocations Tree</a> </li>
    <li> <a href="javascript:roots(getTreeFromRelation(classes, packageType));"> Classes in Packages</a> </li>
     <li> <a href="javascript:roots(getTreeFromRelation(attributes, classType));"> Attributes in Classes</a> </li>
     <li> <a href="javascript: plotGraph()"> CallGraph </a> </li>
</ul>
<div id="treename"></div>
<div id="monitor"></div>
<div class="Block">
	<div id="chart" class="Block Right" style="overflow:visible"> </div>
	<div id="roots" class="Block Left List"></div>
</div>

<!--
<div id="slider_controls"> 
	<input id="playbutton" type="image" src="img/play.png" name="image" width="60" height="60" onClick="play()" />
	<input id="timewarp" type="range" min="0" max="50" value="0" step="5" onchange="showValue(this.value)" />
</div> -->

</body>
</html>
